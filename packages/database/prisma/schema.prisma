generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

enum IntegrationType {
  SENTRY
  SLACK
  PAGERDUTY
  DATADOG
  TEAMS
  DISCORD
  OPSGENIE
  AWS_CLOUDWATCH
  AZURE_MONITOR
  GCP_MONITORING
  PROMETHEUS
  GRAFANA
  GENERIC_WEBHOOK
  JIRA
}

enum IntegrationStatus {
  ACTIVE
  DISABLED
  ERROR
}

enum AlertSeverity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertStatus {
  OPEN
  ACK
  SNOOZED
  RESOLVED
}

enum NotificationTarget {
  SLACK
  TEAMS
  DISCORD
  DATADOG
  PAGERDUTY
  OPSGENIE
}

enum PagingChannel {
  SLACK
  EMAIL
  SMS
  VOICE
}

enum PagingAttemptStatus {
  QUEUED
  SENT
  FAILED
}

enum NotificationStatus {
  SENT
  FAILED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum IncidentRole {
  COMMANDER
  SCRIBE
  LIAISON
  TECH_LEAD
}

enum IncidentTimelineEventType {
  ALERT_CREATED
  ALERT_ACKED
  ALERT_SNOOZED
  ALERT_RESOLVED
  WAR_ROOM_CREATED
  CONFERENCE_LINK_SET
  JIRA_TICKET_CREATED
  ROUTING_NOTIFICATION
  DEPLOYMENT_CORRELATED
  POST_MORTEM_CREATED
  POST_MORTEM_PUBLISHED
  ACTION_ITEM_CREATED
  COMMENT_ADDED
  ROLE_ASSIGNED
}

enum PostMortemStatus {
  DRAFT
  REVIEWING
  PUBLISHED
}

enum StatusPageVisibility {
  PUBLIC
  PRIVATE
}

enum StatusIncidentStatus {
  INVESTIGATING
  IDENTIFIED
  MONITORING
  RESOLVED
}

enum StatusIncidentImpact {
  NONE
  MINOR
  MAJOR
  CRITICAL
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Impact Threshold Configuration (user configurable)
  highImpactUserThreshold   Int   @default(50) // Users affected for "High Impact"
  mediumImpactUserThreshold Int   @default(10) // Users affected for "Medium Impact"
  highVelocityThreshold     Float @default(10) // Events/hour for "High Velocity"

  users            User[]
  integrations     Integration[]
  alertEvents      AlertEvent[]
  alertGroups      AlertGroup[]
  routingRules     RoutingRule[]
  notifications    NotificationLog[]
  correlationRules CorrelationRule[]
  releases         Release[]
  uptimeChecks     UptimeCheck[]
  apiKeys          ApiKey[]
  serviceAccounts  ServiceAccount[]
  idempotencyKeys  IdempotencyKey[]
  teams            Team[]
  escalationPolicies EscalationPolicy[]
  alertPolicies    AlertPolicy[]
  emailIntegration EmailIntegration?
  auditLogs        AuditLog[]
  changeEvents     ChangeEvent[]
  samlConfig       SamlConfig?
  rolePermissions  RolePermission[]
  invitations      Invitation[]
  remediationWorkflows RemediationWorkflow[]
  customDashboards     CustomDashboard[]
  onCallRotations     OnCallRotation[]
  pagingPolicies      PagingPolicy[]
  statusPages        StatusPage[]
  anomalyModels      AnomalyModel[]
  postMortems        PostMortem[]
  webhookRegistries  WebhookRegistry[]
}

model AuditLog {
  id           String   @id @default(cuid())
  workspaceId  String
  userId       String
  action       String // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  resourceType String // AlertGroup, RoutingRule, User, etc.
  resourceId   String? // ID of the affected resource
  metadata     Json? // Additional context (old/new values, etc.)
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@index([workspaceId])
  @@index([userId])
  @@index([workspaceId, createdAt])
  @@index([resourceType, resourceId])
}

model IdempotencyKey {
  id          String   @id @default(cuid())
  workspaceId String
  key         String
  method      String
  path        String
  requestHash String
  status      String   @default("IN_PROGRESS")
  statusCode  Int?
  responseBody Json?
  createdAt   DateTime @default(now())
  expiresAt   DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, key])
  @@index([workspaceId])
  @@index([workspaceId, createdAt])
}

model ApiKey {
  id          String    @id @default(cuid())
  workspaceId String
  name        String // User-friendly name (e.g., "CI/CD Pipeline", "Mobile App")
  keyHash     String    @unique // SHA256 hash of the actual key
  prefix      String // First 8 characters for display (e.g., "sk_live_")
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdBy   String
  serviceAccountId String?
  createdAt   DateTime  @default(now())
  revokedAt   DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  creator   User      @relation(fields: [createdBy], references: [id])
  serviceAccount ServiceAccount? @relation(fields: [serviceAccountId], references: [id])

  @@index([workspaceId])
  @@index([keyHash])
  @@index([serviceAccountId])
  @@index([workspaceId, createdAt])
}

model EmailIntegration {
  id          String   @id @default(cuid())
  workspaceId String   @unique
  apiKey      String // Encrypted SendGrid API key
  fromEmail   String
  fromName    String?
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
}

// Phase 4: Uptime Monitoring
model UptimeCheck {
  id             String   @id @default(cuid())
  workspaceId    String
  name           String
  url            String
  method         String   @default("GET")
  interval       Int      @default(60) // seconds between checks
  timeout        Int      @default(30) // request timeout in seconds
  enabled        Boolean  @default(true)
  headers        Json? // Optional custom headers
  expectedStatus Int? // Expected HTTP status code (default: 2xx)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  workspace Workspace      @relation(fields: [workspaceId], references: [id])
  results   UptimeResult[]

  @@index([workspaceId])
  @@index([workspaceId, enabled])
}

model UptimeResult {
  id            String   @id @default(cuid())
  uptimeCheckId String
  status        String // "up", "down", "degraded"
  responseTime  Int? // Response time in ms
  statusCode    Int? // HTTP status code
  errorMessage  String? // Error message if failed
  checkedAt     DateTime @default(now())

  uptimeCheck UptimeCheck @relation(fields: [uptimeCheckId], references: [id], onDelete: Cascade)

  @@index([uptimeCheckId, checkedAt])
}

model User {
  id          String        @id @default(cuid())
  workspaceId String
  clerkId     String        @unique
  email       String        @unique
  displayName String?
  phoneNumber String?
  role        WorkspaceRole @default(MEMBER)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  workspace           Workspace    @relation(fields: [workspaceId], references: [id])
  assignedAlertGroups AlertGroup[] @relation("AlertGroupAssignee")
  apiKeys             ApiKey[]
  serviceAccountsCreated ServiceAccount[] @relation("ServiceAccountCreator")
  teamsCreated        Team[] @relation("TeamCreator")
  teamMemberships     TeamMember[]
  escalationPoliciesCreated EscalationPolicy[] @relation("EscalationPolicyCreator")
  alertPoliciesCreated AlertPolicy[] @relation("AlertPolicyCreator")
  auditLogs           AuditLog[]
  invitationsCreated  Invitation[] @relation("Inviter")
  workflowsCreated    RemediationWorkflow[] @relation("WorkflowCreator")
  dashboardsCreated   CustomDashboard[] @relation("DashboardCreator")
  onCallRotationsCreated OnCallRotation[] @relation("OnCallRotationCreator")
  onCallLayerParticipants OnCallParticipant[]
  onCallOverrides      OnCallOverride[] @relation("OnCallOverrideUser")
  onCallOverridesCreated OnCallOverride[] @relation("OnCallOverrideCreator")
  pagingAttempts       PagingAttempt[]
  incidentRoleAssignments IncidentRoleAssignment[]
  comments             Comment[]
  assignedActionItems ActionItem[]

  @@index([workspaceId])
}

model ServiceAccount {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  description String?
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  creator   User?      @relation("ServiceAccountCreator", fields: [createdBy], references: [id])
  apiKeys   ApiKey[]

  @@index([workspaceId])
  @@index([createdBy])
  @@unique([workspaceId, name])
}

model Team {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  description String?
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  creator   User?     @relation("TeamCreator", fields: [createdBy], references: [id])
  members   TeamMember[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([createdBy])
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  createdAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model EscalationPolicy {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  description String?
  rulesJson   Json
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  creator   User?     @relation("EscalationPolicyCreator", fields: [createdBy], references: [id])

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([createdBy])
}

model AlertPolicy {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  externalId  String?
  severity    String
  routingKey  String
  conditionsJson Json
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  creator   User?     @relation("AlertPolicyCreator", fields: [createdBy], references: [id])

  @@index([workspaceId])
  @@index([workspaceId, name])
  @@unique([workspaceId, externalId])
  @@index([createdBy])
}

model OnCallRotation {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  timezone    String   @default("UTC")
  description String?
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  creator   User      @relation("OnCallRotationCreator", fields: [createdBy], references: [id])
  layers    OnCallLayer[]
  overrides OnCallOverride[]
  pagingPolicies PagingPolicy[]

  @@index([workspaceId])
  @@index([workspaceId, updatedAt])
}

model PagingPolicy {
  id          String   @id @default(cuid())
  workspaceId String
  rotationId  String
  name        String
  description String?
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  rotation  OnCallRotation @relation(fields: [rotationId], references: [id])
  steps     PagingStep[]
  attempts  PagingAttempt[]

  @@index([workspaceId])
  @@index([rotationId])
}

model PagingStep {
  id                    String   @id @default(cuid())
  policyId              String
  order                 Int      @default(0)
  channels              PagingChannel[]
  delaySeconds          Int      @default(0)
  repeatCount           Int      @default(0)
  repeatIntervalSeconds Int      @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  policy PagingPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@index([policyId])
  @@index([policyId, order])
}

model PagingAttempt {
  id           String             @id @default(cuid())
  policyId     String
  alertGroupId String
  channel      PagingChannel
  status       PagingAttemptStatus
  targetUserId String?
  stepOrder    Int
  attemptNumber Int              @default(1)
  errorMessage String?
  ackToken     String?
  ackedAt      DateTime?
  ackSource    String?
  startedAt    DateTime          @default(now())
  completedAt  DateTime?

  policy     PagingPolicy @relation(fields: [policyId], references: [id])
  alertGroup AlertGroup   @relation(fields: [alertGroupId], references: [id])
  targetUser User?        @relation(fields: [targetUserId], references: [id])

  @@index([policyId])
  @@index([alertGroupId])
  @@index([targetUserId])
  @@index([policyId, alertGroupId])
}

model OnCallLayer {
  id                   String   @id @default(cuid())
  rotationId           String
  name                 String?
  order                Int      @default(0)
  handoffIntervalHours Int      @default(168)
  startsAt             DateTime
  endsAt               DateTime?
  restrictionsJson     Json?
  isShadow             Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  rotation     OnCallRotation    @relation(fields: [rotationId], references: [id], onDelete: Cascade)
  participants OnCallParticipant[]

  @@index([rotationId])
  @@index([rotationId, order])
}

model OnCallParticipant {
  id       String   @id @default(cuid())
  layerId  String
  userId   String
  position Int      @default(0)
  createdAt DateTime @default(now())

  layer OnCallLayer @relation(fields: [layerId], references: [id], onDelete: Cascade)
  user  User        @relation(fields: [userId], references: [id])

  @@index([layerId])
  @@index([userId])
  @@index([layerId, position])
}

model OnCallOverride {
  id         String   @id @default(cuid())
  rotationId String
  userId     String
  startsAt   DateTime
  endsAt     DateTime
  reason     String?
  createdBy  String
  createdAt  DateTime @default(now())

  rotation OnCallRotation @relation(fields: [rotationId], references: [id], onDelete: Cascade)
  user     User           @relation("OnCallOverrideUser", fields: [userId], references: [id])
  creator  User           @relation("OnCallOverrideCreator", fields: [createdBy], references: [id])

  @@index([rotationId])
  @@index([userId])
  @@index([rotationId, startsAt])
}

model Integration {
  id          String            @id @default(cuid())
  workspaceId String
  type        IntegrationType
  status      IntegrationStatus @default(ACTIVE)
  configJson  Json
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, type])
  @@index([workspaceId])
}

model WebhookRegistry {
  id              String          @id @default(cuid())
  workspaceId     String
  name            String
  integrationType IntegrationType
  webhookUrl      String          @unique // Generated URL
  webhookToken    String          @unique // Secret token for validation
  enabled         Boolean         @default(true)

  // Generic webhook configuration
  fieldMappings Json? // JSONPath mappings for title, severity, etc.
  severityMap   Json? // Custom severity mapping

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
  @@index([webhookToken])
}

model AlertEvent {
  id            String        @id @default(cuid())
  workspaceId   String
  alertGroupId  String?
  source        String
  sourceEventId String
  project       String
  environment   String
  severity      AlertSeverity
  fingerprint   String
  tagsJson      Json
  title         String
  message       String
  occurredAt    DateTime
  receivedAt    DateTime      @default(now())
  payloadJson   Json
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  workspace     Workspace      @relation(fields: [workspaceId], references: [id])
  alertGroup    AlertGroup?    @relation(fields: [alertGroupId], references: [id])
  breadcrumbs   Breadcrumb[]
  sessionReplay SessionReplay?

  @@unique([workspaceId, sourceEventId])
  @@index([workspaceId])
  @@index([alertGroupId])
  @@index([alertGroupId, occurredAt]) // Phase 6: Timeline optimization
}

// Phase 5: Session Replay - records of user sessions leading to errors
model SessionReplay {
  id             String   @id @default(cuid())
  alertEventId   String   @unique
  sessionId      String // Client-side session ID
  duration       Int? // Duration in milliseconds
  events         Json // rrweb events (stored as JSON for now, move to object storage for production)
  storageUrl     String? // URL if stored in external storage (R2/S3)
  compressedSize Int? // Size in bytes
  createdAt      DateTime @default(now())

  alertEvent AlertEvent @relation(fields: [alertEventId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

// Phase 2: Breadcrumbs - events leading up to an error
model Breadcrumb {
  id           String   @id @default(cuid())
  alertEventId String
  type         String // "http", "console", "navigation", "click", "user", "debug", "default"
  category     String? // "xhr", "fetch", "ui", "info", "query"
  message      String
  level        String   @default("info") // "debug", "info", "warning", "error"
  data         Json? // Additional context: { url, method, statusCode, duration }
  timestamp    DateTime

  alertEvent AlertEvent @relation(fields: [alertEventId], references: [id], onDelete: Cascade)

  @@index([alertEventId, timestamp])
}

model AlertGroup {
  id             String        @id @default(cuid())
  workspaceId    String
  groupKey       String
  title          String
  severity       AlertSeverity
  environment    String
  project        String        @default("default") // Phase 5: Project for filtering
  status         AlertStatus   @default(OPEN)
  assigneeUserId String?
  firstSeenAt    DateTime
  lastSeenAt     DateTime
  count          Int           @default(1)
  runbookUrl     String?
  runbookMarkdown String?
  snoozeUntil    DateTime? // Phase 4: Alert hygiene - snooze expiry
  resolvedAt     DateTime? // Phase 4: Track when alert was resolved

  // Differentiation: Resolution Memory
  resolutionNotes   String? // What fixed this alert
  lastResolvedBy    String? // User who resolved (clerkId or Slack userId)
  avgResolutionMins Int? // Rolling average time to resolve (minutes)

  // Differentiation: Impact Estimation
  userCount       Int? // Affected users (from source like Sentry)
  velocityPerHour Float? // Occurrences per hour (calculated)

  // Release Tracking
  releaseId String?

  // Jira Ticketing
  jiraIssueKey String?
  jiraIssueUrl String?

  // Incident Management
  conferenceUrl     String?
  warRoomChannelId  String?
  warRoomChannelName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace     Workspace         @relation(fields: [workspaceId], references: [id])
  assignee      User?             @relation("AlertGroupAssignee", fields: [assigneeUserId], references: [id])
  release       Release?          @relation(fields: [releaseId], references: [id])
  notifications NotificationLog[]
  alertEvents   AlertEvent[]
  incidentRoleAssignments IncidentRoleAssignment[]
  incidentTimelineEntries IncidentTimelineEntry[]
  statusPageIncidents StatusPageIncident[]
  workflowExecutions WorkflowExecution[]
  primaryCorrelations AlertCorrelation[] @relation("PrimaryAlert")
  relatedCorrelations AlertCorrelation[] @relation("RelatedAlert")
  pagingAttempts   PagingAttempt[]
  externalMappings ExternalMapping[]
  postMortem       PostMortem?
  comments         Comment[]

  @@index([groupKey])
  @@index([workspaceId])
  @@index([status])
  @@index([lastSeenAt])
  @@index([workspaceId, status, lastSeenAt]) // Phase 6: Inbox optimization
  @@index([workspaceId, environment]) // Phase 6: Filter optimization
  @@index([workspaceId, project]) // Phase 6: Filter optimization
  @@index([releaseId]) // Release tracking
}

model ExternalMapping {
  id              String          @id @default(cuid())
  alertGroupId    String
  integrationType IntegrationType
  externalId      String
  metadata        Json
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  alertGroup AlertGroup @relation(fields: [alertGroupId], references: [id])

  @@unique([alertGroupId, integrationType])
  @@index([externalId])
}

model StatusPage {
  id          String               @id @default(cuid())
  workspaceId String
  slug        String               @unique
  title       String
  description String?
  visibility  StatusPageVisibility @default(PUBLIC)
  isActive    Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  workspace   Workspace            @relation(fields: [workspaceId], references: [id])
  incidents   StatusPageIncident[]
  subscribers StatusPageSubscriber[]

  @@index([workspaceId])
}

model StatusPageIncident {
  id           String               @id @default(cuid())
  statusPageId String
  alertGroupId String?
  title        String
  status       StatusIncidentStatus
  impact       StatusIncidentImpact @default(MINOR)
  message      String?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  resolvedAt   DateTime?

  statusPage StatusPage  @relation(fields: [statusPageId], references: [id], onDelete: Cascade)
  alertGroup AlertGroup? @relation(fields: [alertGroupId], references: [id])

  @@index([statusPageId])
  @@index([alertGroupId])
  @@index([statusPageId, status])
}

model StatusPageSubscriber {
  id           String   @id @default(cuid())
  statusPageId String
  email        String
  verified     Boolean  @default(false)
  verifyToken  String
  unsubscribedAt DateTime?
  createdAt    DateTime @default(now())

  statusPage StatusPage @relation(fields: [statusPageId], references: [id], onDelete: Cascade)

  @@unique([statusPageId, email])
  @@index([statusPageId])
  @@index([email])
}

model IncidentTimelineEntry {
  id           String   @id @default(cuid())
  alertGroupId String
  type         IncidentTimelineEventType
  title        String
  message      String?
  source       String? // system, user, integration name
  metadataJson Json?
  occurredAt   DateTime @default(now())

  alertGroup AlertGroup @relation(fields: [alertGroupId], references: [id], onDelete: Cascade)

  @@index([alertGroupId])
  @@index([alertGroupId, occurredAt])
}

model AnomalyModel {
  id          String   @id @default(cuid())
  workspaceId String
  metricKey   String
  baseline    Json
  lastUpdated DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, metricKey])
  @@index([workspaceId])
}

model ChangeEvent {
  id          String   @id @default(cuid())
  workspaceId String
  type        String
  source      String
  title       String?
  project     String?
  environment String?
  actor       String?
  details     Json?
  timestamp   DateTime @default(now())
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
  @@index([workspaceId, timestamp])
  @@index([workspaceId, project])
  @@index([workspaceId, environment])
}

model IncidentRoleAssignment {
  id           String       @id @default(cuid())
  alertGroupId String
  userId       String
  role         IncidentRole
  createdAt    DateTime     @default(now())

  alertGroup AlertGroup @relation(fields: [alertGroupId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id])

  @@unique([alertGroupId, role])
  @@index([alertGroupId])
  @@index([userId])
}

model Release {
  id          String   @id @default(cuid())
  workspaceId String
  version     String // e.g., "v2.3.1", "1.0.0-beta"
  environment String // production, staging, development
  project     String  @default("default")
  commitSha   String? // Git commit SHA
  deployedAt  DateTime @default(now())
  createdAt   DateTime @default(now())

  workspace   Workspace    @relation(fields: [workspaceId], references: [id])
  alertGroups AlertGroup[]

  @@unique([workspaceId, version, environment, project])
  @@index([workspaceId])
  @@index([workspaceId, deployedAt])
}

model RoutingRule {
  id             String   @id @default(cuid())
  workspaceId    String
  name           String // Phase 4: Human-readable rule name
  description    String? // Phase 4: Rule description
  conditionsJson Json
  actionsJson    Json
  priority       Int      @default(0) // Phase 4: Lower = higher priority
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
  @@index([workspaceId, enabled, priority]) // Phase 4: Optimized rule query
}

model NotificationLog {
  id           String             @id @default(cuid())
  workspaceId  String
  target       NotificationTarget
  targetRef    String
  alertGroupId String
  status       NotificationStatus
  errorMessage String?
  sentAt       DateTime           @default(now())

  workspace  Workspace  @relation(fields: [workspaceId], references: [id])
  alertGroup AlertGroup @relation(fields: [alertGroupId], references: [id])

  @@index([workspaceId])
  @@index([alertGroupId])
  @@index([sentAt])
}

model CorrelationRule {
  id             String   @id @default(cuid())
  workspaceId    String
  sourceGroupKey String // The "cause" or first alert
  targetGroupKey String // The "effect" or subsequent alert
  confidence     Float // 0.0 to 1.0
  lastUpdatedAt  DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, sourceGroupKey, targetGroupKey])
  @@index([workspaceId, sourceGroupKey])
}

// Phase 4: SAML SSO Configuration
model SamlConfig {
  id              String   @id @default(cuid())
  workspaceId     String   @unique
  enabled         Boolean  @default(false)
  enforced        Boolean  @default(false) // Force SAML for all users
  idpEntityId     String? // Identity Provider Entity ID
  idpSsoUrl       String? // IdP Single Sign-On URL
  idpCertificate  String?  @db.Text // IdP X.509 Certificate (PEM format)
  spEntityId      String? // Service Provider Entity ID (auto-generated)
  allowedDomains  String[] // Email domains allowed for SAML auth
  jitProvisioning Boolean  @default(true) // Just-In-Time user creation
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
}

// Phase 4: Enhanced RBAC - Permission Actions
enum PermissionAction {
  READ
  WRITE
  DELETE
  MANAGE
}

// Phase 4: Enhanced RBAC - Permission Definition
model Permission {
  id          String           @id @default(cuid())
  name        String           @unique // e.g., "alerts", "routing", "settings", "users"
  description String?
  rolePerms   RolePermission[]
}

// Phase 4: Enhanced RBAC - Role Permission Mapping
model RolePermission {
  id           String             @id @default(cuid())
  workspaceId  String
  role         WorkspaceRole // OWNER, ADMIN, MEMBER
  permissionId String
  actions      PermissionAction[]

  workspace  Workspace  @relation(fields: [workspaceId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@unique([workspaceId, role, permissionId])
  @@index([workspaceId])
  @@index([workspaceId, role])
}

model Invitation {
  id          String           @id @default(cuid())
  workspaceId String
  email       String
  role        WorkspaceRole    @default(MEMBER)
  token       String           @unique
  inviterId   String
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime
  acceptedAt  DateTime?
  revokedAt   DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  inviter   User      @relation("Inviter", fields: [inviterId], references: [id])

  @@index([workspaceId])
  @@index([token])
  @@index([email])
}

enum WorkflowExecutionStatus {
  RUNNING
  SUCCESS
  FAILED
  CANCELLED
}

model RemediationWorkflow {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  description String?
  enabled     Boolean  @default(true)
  trigger     Json
  steps       Json
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace  Workspace           @relation(fields: [workspaceId], references: [id])
  creator    User                @relation("WorkflowCreator", fields: [createdBy], references: [id])
  executions WorkflowExecution[]

  @@index([workspaceId])
  @@index([enabled])
}

model WorkflowExecution {
  id          String                  @id @default(cuid())
  workflowId  String
  alertId     String
  status      WorkflowExecutionStatus @default(RUNNING)
  startedAt   DateTime                @default(now())
  completedAt DateTime?
  result      Json?
  error       String?
  logs        Json?

  workflow RemediationWorkflow @relation(fields: [workflowId], references: [id])
  alert    AlertGroup          @relation(fields: [alertId], references: [id])

  @@index([workflowId])
  @@index([alertId])
  @@index([status])
}

model AlertCorrelation {
  id               String   @id @default(cuid())
  primaryAlertId   String
  relatedAlertId   String
  correlationScore Float
  reason           String
  createdAt        DateTime @default(now())

  primaryAlert AlertGroup @relation("PrimaryAlert", fields: [primaryAlertId], references: [id])
  relatedAlert AlertGroup @relation("RelatedAlert", fields: [relatedAlertId], references: [id])

  @@index([primaryAlertId])
  @@index([relatedAlertId])
  @@unique([primaryAlertId, relatedAlertId])
}

model CustomDashboard {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  description String?
  layout      Json
  widgets     Json
  isDefault   Boolean  @default(false)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  creator   User      @relation("DashboardCreator", fields: [createdBy], references: [id])

  @@index([workspaceId])
  @@index([createdBy])
}

model PostMortem {
  id              String           @id @default(cuid())
  alertGroupId    String           @unique
  workspaceId     String
  status          PostMortemStatus @default(DRAFT)
  title           String
  summary         String?          @db.Text
  impact          String?          @db.Text
  rootCause       String?          @db.Text
  actionItems     ActionItem[]
  publishedAt     DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  alertGroup AlertGroup @relation(fields: [alertGroupId], references: [id], onDelete: Cascade)
  workspace  Workspace  @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
  @@index([status])
}

model ActionItem {
  id           String   @id @default(cuid())
  postMortemId String
  title        String
  description  String? @db.Text
  status       String   @default("TODO") // "TODO", "IN_PROGRESS", "DONE", "CANCELLED"
  priority     String   @default("MEDIUM") // "LOW", "MEDIUM", "HIGH"
  assigneeId   String?
  dueDate      DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  postMortem PostMortem @relation(fields: [postMortemId], references: [id], onDelete: Cascade)
  assignee   User?      @relation(fields: [assigneeId], references: [id])
}

model Comment {
  id           String   @id @default(cuid())
  alertGroupId String
  userId       String
  content      String   @db.Text
  parentId     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  alertGroup AlertGroup @relation(fields: [alertGroupId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id])
  parent     Comment?   @relation("CommentReplies", fields: [parentId], references: [id])
  replies    Comment[]  @relation("CommentReplies")

  @@index([alertGroupId])
  @@index([userId])
  @@index([parentId])
}
